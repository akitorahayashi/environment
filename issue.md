タイトル: セットアップスクリプトのGitHub Actionsジョブ分割によるCI高速化と責務分離

本文:

背景
現在のCIパイプラインは、単一のジョブ内で install.sh を実行し、すべてのセットアップを直列で行っています。これにより、CIの実行時間が長くなっており、開発サイクルのボトルネックとなりつつあります。また、冪等性チェックを含む多くの責務が install.sh に集中しており、メンテナンス性の低下を招いています。

提案: 各スクリプトのジョブ化とアーキテクチャ刷新
CIの実行時間を抜本的に改善し、メンテナンス性を向上させるため、アーキテクチャを以下の通り変更することを提案します。

1. 各セットアップスクリプトの責務変更
依存関係の自己解決:
各スクリプト (git.sh, node.sh 等) は、自身の処理に必要な依存パッケージを、スクリプト冒頭で brew install <package> を実行して自己解決するように修正します。
状態変更のシグナル (標準エラー出力):
各スクリプトは、処理中に状態変更（新規パッケージインストール、rbenv/pyenvでのバージョン切り替え等）が発生した場合にのみ、標準エラー出力 (stderr) に STATE_CHANGED という文字列を出力 します。
このシグナルはスクリプトの終了ステータスに影響を与えません。シンボリックリンク作成やmacOSの設定適用など、元々冪等な操作では出力しません。
2. install.sh の役割再定義
ローカル実行専用ランナー:
install.sh は、ローカル環境でのセットアップ専用 のスクリプトと位置づけます。
ローカルでの安全性を重視し、従来通り 各スクリプトを直列で実行 します。
冪等性チェックロジックの削除:
現在 install.sh に実装されている冪等性チェックのロジックは、責務が各CIジョブに移管されるため、install.sh からは削除します。これにより、install.sh はシンプルな逐次実行スクリプトになります。
3. Brewfile 及び homebrew.sh の役割変更
共通ツールのみを管理:
Brewfile は、特定のスクリプトに依存しない共通ツール (例: yamllint) のみを管理するように変更し、各スクリプトの依存パッケージは削除します。
(注) これにより、Brewfile はインストールされるすべてのHomebrewパッケージを網羅しなくなります。
homebrew.sh は、brew コマンド自体のインストールと、この軽量化された Brewfile のみを処理します。
4. GitHub Actions ワークフローの刷新
再利用可能なワークフロー (Reusable Workflow) の導入:

各セットアップスクリプト（例: git.sh）に対して、それに対応する 再利用可能なワークフロー（例: setup-git.yml）を .github/workflows/ ディレクトリに作成します。
この再利用可能なワークフローは、以下の責務を持ちます。
対象スクリプトの1回目の実行 (セットアップ)。
対象スクリプトの2回目の実行 (冪等性チェック)。
2回目の実行時に 標準エラー出力 (stderr) をキャプチャし、STATE_CHANGED という文字列が含まれている場合、冪等性違反とみなしジョブを失敗させます。
メインパイプライン (ci-pipeline.yml) の責務変更:

ci-pipeline.yml は、install.sh の呼び出しを廃止します。
まず、homebrew をセットアップするジョブを実行します。
次に、上記で作成した 再利用可能なワークフロー群を workflow_call を使って並列で呼び出します。これにより、メインパイプラインは各ジョブの詳細な実装を知ることなく、全体の流れをオーケストレーションすることに専念できます。
期待される効果
CI実行時間の大幅な短縮
依存関係と責務の明確化によるメンテナンス性の向上
ワークフローの再利用性と可読性の向上
障害耐性の向上
