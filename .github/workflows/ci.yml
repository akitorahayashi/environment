name: macOS環境構築のCI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 手動実行も可能にする

jobs:
  test-install:
    runs-on: macos-latest
    timeout-minutes: 120  # Xcodeのインストールに時間がかかるため、タイムアウトを延長
    
    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v3
      
      - name: GitHub認証の設定
        run: |
          # GitHubの認証を設定 (CI環境用)
          git config --global url."https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          echo "✅ CI環境用のGitHub認証を設定しました"
      
      - name: スクリプトに実行権限を付与
        run: |
          chmod +x install.sh
          chmod +x scripts/setup/*.sh
          chmod +x scripts/utils/*.sh
          echo "✅ 全スクリプトに実行権限を付与しました"
      
      - name: インストールスクリプトの実行
        run: |
          # 環境変数の設定
          export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
          export ANDROID_SDK_ROOT=$HOME/Library/Android/sdk
          export REPO_ROOT=$GITHUB_WORKSPACE
          export IS_CI=true
          export ALLOW_COMPONENT_FAILURE=true
          export ANDROID_LICENSES=true
          
          # インストールスクリプトを実行
          ./install.sh
          
          # インストールスクリプトの終了コードを確認
          INSTALL_EXIT_CODE=$?
          echo "インストールスクリプトの終了コード: $INSTALL_EXIT_CODE"
          
          if [ $INSTALL_EXIT_CODE -ne 0 ]; then
            echo "❌ インストールスクリプトがエラーで終了しました"
            exit $INSTALL_EXIT_CODE
          fi
        env:
          CI: true
          GITHUB_TOKEN_CI: ${{ secrets.GITHUB_TOKEN }}
      
      - name: インストール後の環境検証
        run: |
          # 環境変数の設定
          export REPO_ROOT=$GITHUB_WORKSPACE
          export IS_CI=true
          export ALLOW_COMPONENT_FAILURE=true
          
          # 検証スクリプトに実行権限を付与
          chmod +x $GITHUB_WORKSPACE/.github/workflows/ci_verify.sh
          
          # 検証スクリプトを実行
          $GITHUB_WORKSPACE/.github/workflows/ci_verify.sh
          
          # 検証スクリプトの終了コードを確認
          VERIFY_EXIT_CODE=$?
          echo "検証スクリプトの終了コード: $VERIFY_EXIT_CODE"
          
          if [ $VERIFY_EXIT_CODE -ne 0 ]; then
            echo "❌ 環境検証に失敗しました"
            exit $VERIFY_EXIT_CODE
          else
            echo "✅ 環境検証が正常に完了しました"
          fi
        env:
          CI: true
          GITHUB_WORKSPACE: ${{ github.workspace }}

  # 全体の検証結果の表示
  summary:
    needs: test-install
    runs-on: ubuntu-latest
    steps:
      - name: 結果のサマリー
        run: |
          echo "✅ macOS環境構築のCIが正常に完了しました"
          echo "🎉 全てのテストに合格しました！"