name: Setup Installers

on:
  workflow_call:

jobs:
  setup-installer:
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        # Test each configuration type in isolation
        config: [only-common, only-macbook, only-mac-mini]
        # Test each component
        component: [git, node, ruby, python, flutter, java, vscode, brew]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure config files exist
        if: matrix.config != 'only-common' # only run for machine-specific configs
        run: |
          machine_type=$(echo ${{ matrix.config }} | sed 's/only-//')
          bash installers/scripts/ensure-configs.sh "$machine_type"

      - name: Debug Environment
        run: |
          echo "--- DEBUGGING ---"
          echo "Current directory: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "--- File Listing (root) ---"
          ls -la
          echo "--- File Listing (installers) ---"
          ls -la installers
          echo "--- File Listing (installers/scripts) ---"
          ls -la installers/scripts
          echo "--- END DEBUGGING ---"

      - name: Run ${{ matrix.config }}-${{ matrix.component }} setup
        id: setup
        run: make -C installers ${{ matrix.config }}-${{ matrix.component }}

      - name: Run ${{ matrix.config }}-${{ matrix.component }} setup for idempotency check
        id: idempotency
        run: |
          set -o pipefail
          stderr_output=$( (make -C installers ${{ matrix.config }}-${{ matrix.component }} >/dev/null) 2>&1 || true )
          {
            echo "stderr_output<<EOF"
            echo "${stderr_output}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Verify idempotency
        if: contains(steps.idempotency.outputs.stderr_output, 'IDEMPOTENCY_VIOLATION')
        run: |
          echo "Idempotency check failed for ${{ matrix.config }}-${{ matrix.component }}"
          echo "Error output:"
          echo "${{ steps.idempotency.outputs.stderr_output }}"
          exit 1
