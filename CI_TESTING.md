# install.sh の CI

このドキュメントでは、macOS環境インストールスクリプト（`install.sh`）のCIの設定について説明する。CIワークフローは、インストールスクリプトがクリーンなmacOS環境で正しく動作することを検証するために設計されている。

## 概要

CIワークフローはGitHub Actionsを使用して、クリーンなmacOS環境で`install.sh`スクリプトを実行し、すべてのコンポーネントが正しくインストールおよび設定されていることを確認する。これにより、新しいユーザーや新しくフォーマットされたマシンでスクリプトが確実に動作することを保証できる。

## GitHub Actionsの無料枠と使用制限

GitHub Actionsには以下の無料枠が提供されている：

| プラン                     | ストレージ | 分 (月あたり) |
| ----------------------- | ------- | -------- |
| GitHub Free             | 500 MB  | 2,000    |
| GitHub Pro              | 1 GB    | 3,000    |
| 組織の GitHub Free         | 500 MB  | 2,000    |
| GitHub Team             | 2 GB    | 3,000    |
| GitHub Enterprise Cloud | 50 GB   | 50,000   |

注意点：
- パブリックリポジトリでの使用は無料である
- macOSランナーは分の消費が10倍になる（例：macOSで100分使用すると1,000分としてカウントされる）
- 無料枠を超えた場合、追加料金が発生する（macOSの場合は分あたり0.08米ドル）
- 分は毎月リセットされるが、ストレージはリセットされない

本リポジトリはパブリックリポジトリであるため、GitHub Actionsの使用は基本的に無料である。ただし、macOSランナーを使用するため、月間の実行回数には注意が必要である。

## CIワークフロー設定

CIワークフローは`.github/workflows/test-install.yml`で定義され、以下のタイミングでトリガーされる：
- `main`ブランチへのプッシュ
- `main`ブランチを対象とするプルリクエスト
- 手動ワークフローディスパッチ

## テストプロセス

ワークフローは以下のテストを実行する：

### 1. 基本インストール検証
- Homebrewが正しくインストールされていることを確認
- Xcode Command Line Toolsが利用可能であることを確認
- シェル設定ファイルが存在することを確認

### 2. シンボリックリンク検証
- `.zshrc`と`.zprofile`がリポジトリファイルに正しくリンクされていることを確認
- `.gitconfig`と`.gitignore_global`が適切にリンクされていることを確認
- Homebrewのパスが`.zprofile`に正しく設定されていることを確認

### 3. Git設定検証
- Gitのグローバル除外ファイルが正しく設定されていることを確認

### 4. パッケージインストール検証
- `git`や`jq`などの必須パッケージがインストールされていることを確認
- Brewfileで指定されている場合、`xcodes`や`flutter`などのオプションパッケージを確認

### 5. Flutterセットアップ検証（インストールされている場合）
- Flutterの基本設定を確認
- Android SDK環境変数を検証

### 6. Cursor IDE設定検証（インストールされている場合）
- Cursor設定ファイルが存在することを確認
- Cursor設定でのFlutter SDKパス設定を確認

### 7. 冪等性テスト
- インストールスクリプトを2回目に実行して、複数回実行してもエラーが発生しないことを確認

## CI環境の考慮事項

CIワークフローはGitHub ActionsのmacOSランナーで実行されるが、いくつかの制限がある：

1. **GUIテストの制限**: CI環境ではGUIアプリケーションやインタラクションをテストできない。
2. **Xcodeの制限**: 完全なXcodeのインストールは時間とリソースを大量に消費するため、基本的なXcode Command Line Toolsのみ検証する。
3. **システム環境設定**: macOSのシステム環境設定の変更はCI環境で完全にテストできない。
4. **ハードウェア固有の機能**: Apple SiliconのRosetta 2のような機能は、ランナーのハードウェアによっては完全にテストできない場合がある。

## CIのためのインストールスクリプトの適応

`install.sh`スクリプトには、CI固有の適応が含まれている：
- `CI`環境変数を使用してCI環境を検出
- CI実行時の対話的プロンプトをスキップ
- 完全なXcodeインストールなどの時間のかかる操作をバイパス
- ユーザー操作やGUIを必要とする操作を省略

## CIテストの利点

1. **問題の早期発見**: インストールスクリプトの問題がユーザーに影響する前に特定できる。
2. **リグレッション防止**: スクリプトの変更が既存の機能を壊さないことを確認できる。
3. **冪等性の検証**: スクリプトが複数回安全に実行できることを確認できる。
4. **ドキュメント**: インストールスクリプトが達成すべきことの実行可能なドキュメントとして機能する。

## 将来の改善点

CIテストの潜在的な強化：

1. **マトリックステスト**: 複数のmacOSバージョンでテスト。
2. **パフォーマンスメトリクス**: インストール時間とリソース使用量を測定。
3. **拡張パッケージテスト**: Brewfileからより多くのオプションパッケージを検証。
4. **アンインストールテスト**: クリーンなアンインストールプロセスを検証。
5. **他のツールとの統合**: 開発ワークフローとの統合をテスト。

## 結論

CIワークフローは、macOS環境セットアップスクリプトが正しく一貫して動作することを確認する。クリーンな環境で自動的にテストすることで、新しいユーザーがスムーズなセットアップ体験を得られることを保証できる。 