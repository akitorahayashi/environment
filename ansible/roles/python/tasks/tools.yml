---
- name: "Install pipx tools"
  ansible.builtin.shell: |
    eval "$(pyenv init -)"
    pipx install --python {{ ansible_env.HOME }}/.pyenv/versions/{{ python_version }}/bin/python {{ item }}
  args:
    executable: /bin/bash
  loop: "{{ lookup('file', role_path + '/config/common/pipx-tools.txt').splitlines() | reject('match', '^#') | reject('equalto', '') }}"
  changed_when: false

- name: "Check if mlx-lm venv exists"
  ansible.builtin.stat:
    path: "{{ repo_root_path }}/mlx-lm"
  register: python_mlx_lm_venv

- name: "Fail if mlx-lm venv is missing"
  ansible.builtin.fail:
    msg: "mlx-lm venv not found at {{ repo_root_path }}/mlx-lm. Run 'make base' first."
  when: not python_mlx_lm_venv.stat.exists

- name: "Create mlx-lm directory in user's local"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/mlx_lm"
    state: directory
    mode: "0755"

- name: "Symlink mlx-lm bin directory to user's local bin"
  ansible.builtin.file:
    src: "{{ repo_root_path }}/mlx-lm/bin"
    dest: "{{ ansible_env.HOME }}/.local/mlx_lm/bin"
    state: link
    force: true
