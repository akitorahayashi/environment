#!/usr/bin/env bash

set -e

# スクリプト自体の絶対パスを取得
SCRIPT_PATH=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)/$(basename "${BASH_SOURCE[0]}")
# スクリプトが配置されているディレクトリ (cli-tools/swstyle/ のはず)
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")
# ベースとなるテンプレートディレクトリ
TEMPLATE_BASE_DIR="$SCRIPT_DIR/template"

# logging.sh を見つけるためにリポジトリルートを特定 (utils を使う場合)
REPO_ROOT=$(cd "$SCRIPT_DIR/../.." &>/dev/null && pwd)
source "$REPO_ROOT/scripts/utils/logging.sh" || {
    echo "[swstyle] Error: Failed to load logging.sh" >&2
    exit 1
}

# --- 引数処理 ---
TARGET_TYPE="$1"

if [ -z "$TARGET_TYPE" ]; then
    log_error "エラー: ターゲットタイプを指定してください (project または playground)。"
    echo "使用法: $0 <project|playground>" >&2
    exit 1
fi

TEMPLATE_DIR=""
case "$TARGET_TYPE" in
    project)
        TEMPLATE_DIR="$TEMPLATE_BASE_DIR/project"
        ;;
    playground)
        TEMPLATE_DIR="$TEMPLATE_BASE_DIR/playground"
        ;;
    *)
        log_error "エラー: 無効なターゲットタイプです: $TARGET_TYPE"
        echo "使用法: $0 <project|playground>" >&2
        exit 1
        ;;
esac

# --- メイン処理 ---
log_start "Swift スタイル設定ファイル ($TARGET_TYPE 用) をカレントディレクトリにコピーします..."

# テンプレートディレクトリが存在するか確認
if [ ! -d "$TEMPLATE_DIR" ]; then
    log_error "テンプレートディレクトリが見つかりません: $TEMPLATE_DIR"
    exit 1
fi

# テンプレートファイルが存在するか確認し、コピー (存在すれば上書き)
FILES_TO_COPY=(".swiftlint.yml" ".swiftformat")
COPY_SUCCESS=true

for file in "${FILES_TO_COPY[@]}"; do
    source_file="$TEMPLATE_DIR/$file"
    target_file="./$file" # カレントディレクトリにコピー

    if [ ! -f "$source_file" ]; then
        log_warning "テンプレートファイルが見つかりません: $source_file" # エラーにはしない
        COPY_SUCCESS=false
    else
        log_info "Copying $source_file to $target_file ..."
        # cp -f で強制上書き
        cp -f "$source_file" "$target_file"
        if [ $? -ne 0 ]; then
            log_error "$target_file へのコピーに失敗しました。"
            COPY_SUCCESS=false
        else
            log_success "Copied $file successfully."
        fi
    fi
done

if [ "$COPY_SUCCESS" = true ]; then
    log_success "Swift スタイル設定ファイル ($TARGET_TYPE 用) のコピーが完了しました。"
    exit 0
else
    log_warning "いくつかのテンプレートファイルのコピーに問題がありました。"
    exit 1 # 部分的に失敗した場合は 0 以外で終了
fi 